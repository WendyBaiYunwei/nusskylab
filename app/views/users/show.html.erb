<% content_for :main_content do %>
  <% javascript 'users.js' %>
  <div class="panel panel-default">
    <div class="panel-heading">
      <h2>
        <span>Hi, <%= @user.user_name %> </span>
      </h2>
    </div>
    <div class="panel-body">
      <div role="tabpanel">
        <ul class="nav nav-tabs" role="tablist">
          <li role="presentation" class="active">
            <a href="#user-details" aria-controls="user-details"
               role="tab" data-toggle="tab">
              User details
            </a>
          </li>
          <li role="presentation">
            <a href="#user-roles" aria-controls="user-roles"
               role="tab" data-toggle="tab">
              User access
            </a>
          </li>
        </ul>
        <div class="tab-content">
          <div role="tabpanel" class="tab-pane fade in active" id="user-details">
            <div class="col-sm-12">
              <%= render 'user_details', locals: {user: @user} %>
              <div class="panel panel-info">
                <div class="panel-heading">
                  <h3 class="text-center">Forum Contributions [<%= @user.thredded_user_detail.posts_count %>]</h3>
                </div>
                <div class="panel-body">
                  <%= Thredded::ApplicationController.render partial: 'thredded/users/posts', locals: {posts: Thredded.posts_page_view(scope: @user.thredded_posts.order_newest_first.limit(5), current_user: @user)} %>
                </div>
              </div>
            </div>
          </div>
          <div role="tabpanel" class="tab-pane fade" id="user-roles">
            <div class="col-sm-12">	
            <br>	
              <div class="jumbotron">	
                <% adm, adv, men, stu = user_admin?, user_adviser?, user_mentor?, user_student? || user_pending_student? %>	
                <% if adm or adv or men or stu %>
                  <% if !stu %>
                    <p>Use Skylab as:</p>	
                    <p>	
                      <% if adm and adv %>	
                        <a href="<%= admin_path(adm.id) %>" class="btn btn-primary btn-lg">An Admin</a>	
                        <a href="<%= adviser_path(adv.id) %>" class="btn btn-primary btn-lg">An Adviser</a>	
                      <% elsif adm %>	
                        <a href="<%= admin_path(adm.id) %>" class="btn btn-primary btn-lg">An Admin</a>	
                      <% elsif adv %>	
                        <a href="<%= adviser_path(adv.id) %>" class="btn btn-primary btn-lg">An Adviser</a>	
                      <% else %>	
                        <a href="<%= mentor_path(men.id) %>" class="btn btn-primary btn-lg">A Mentor</a>			
                      <% end %>	
                    </p>		
                  <% else %>
                    <% pending_stu = (user_pending_student?) %>
                      <% if !pending_stu %>
                        <p>Use Skylab as:</p>	
                        <a href="<%= student_path(stu.id) %>" class="btn btn-primary btn-lg">A Student</a>
                      <% else %> <!--a student-->
                        <div style="margin: 0 auto; font-size: 20px; text-align: center;">Application Procedure</div>
                        <br>
                        <div style="overflow: hidden; width: 1000px; margin: auto; padding-left: 42px; text-align: center;">
                          <div style="background: #0066cc; width: 210px; height: 40px; float: left; color: white; padding-top: 10px;">Form Team</div>
                          <div style="float: left; width: 0; height: 0; border-top: 20px solid transparent; border-bottom: 20px solid transparent; border-left: 20px solid #0066cc;"></div>
                          <div style="background: #0066cc; width: 210px; height: 40px; float: left; color: white; padding-top: 10px;">Submit Proposal</div>
                          <div style="float: left; width: 0; height: 0; border-top: 20px solid transparent; border-bottom: 20px solid transparent; border-left: 20px solid #0066cc;"></div>
                          <div style="background: #0066cc; width: 210px; height: 40px; float: left; color: white; padding-top: 10px;">Peer Evaluation</div>
                          <div style="float: left; width: 0; height: 0; border-top: 20px solid transparent; border-bottom: 20px solid transparent; border-left: 20px solid #0066cc;"></div>
                          <div style="background: #0066cc; width: 210px; height: 40px; float: left; color: white; padding-top: 10px;">Release of application result</div>
                        </div>
                        <br>
                        <!-- to-do: should maintain only 1 application status for either student or team -> team -->
                        <% status = (stu.team == nil ? stu.application_status : stu.team.application_status)%>
                        <!-- stage a, form teams -->
                        <% if status[0] == 'a' %>
                          <% if !stu.team %>
                            <p>	
                              You have not formed a team. You may <a href="<%= register_as_team_user_path(@user.id) %>" class="btn btn-primary">invite</a> a teammate now.
                            </p>
                            <p>
                              Please ensure that you are in a team by <%= form_team_ddl %>.
                            </p>
                          <% elsif stu.team.invitor_student_id != stu.id %>	
                            <p>	
                              You have been invited to participate in Orbital as a team with <strong><%= stu.team.invitor_student.user.user_name %></strong>. Respond to <a href="<%= register_as_team_user_path(@user.id) %>" class="btn btn-primary"> the invitation </a> now?	
                            </p>
                            <p>
                              Please ensure that you are in a team by <%= form_team_ddl %>.
                            </p>	
                          <% elsif stu.team.invitor_student_id == stu.id %>	
                            <p>	
                              You have invited <strong><%= stu.team.invitee_student.user.user_name %></strong> to your team and we are waiting for his/her confirmation.
                            </p>	
                            <p>
                              You may withdraw your invitation at <a href="<%= withdraw_invitation_user_path(@user.id) %>" class="btn btn-warning">Withdraw</a>.
                            </p>
                            <p>
                              Please ensure that you are in a team by <%= form_team_ddl %>.
                            </p>
                          <% end %>
                        <!-- stage b, submit proposal -->
                        <% elsif status[0] == 'b' %>
                          <% if !stu.team.proposal_link%>
                            <p>	
                            You have successfully teamed up with user lalala. Please use the section below to <a href="<%= submit_proposal_user_path(@user.id) %>" class="btn btn-warning"> submit </a> a project proposal for your team by <%= submit_proposal_ddl %>. Only one member of the team needs to do the submission. 
                            </p>
                          <% else %>
                            <p>
                            Your team has submitted the project proposal on time. Please come back to the Skylab for peer evaluation on <%= peer_evaluation_open_date %>. There is no action required from you for now.
                            </p>
                            <p>
                            You may <a href="<%= remove_proposal_user_path(@user.id) %>" class="btn btn-warning">delete</a> your old submission and resubmit by the deadline.
                            </p>
                          <% end %>
                        <!-- stage c, peer evaluation -->
                        <% elsif status[0] == 'c' %>
                          <p>Please <a href="<%= do_evaluation_user_path(@user) %>" class="btn btn-primary">evaluate</a> other teamsâ€™ submissions by <%= peer_evaluation_ddl%>. Both members of your team have to finish the evaluation.</p>

                          <p>If you have already submitted the peer evaluation, please wait for the release of application result email. There is no more action required for the application.</p>

                          <p>Note: After the submission, you will receive an email confirmation. Please retain the email as evidence of your submission and wait for the application result on <%= result_release_date%>.</p>
                        <!-- stage d, release result -->
                        <% elsif status == 'success' %>
                          <p>Application status: Successful.</p>
                          <p>You will be able to access the Skylab as an official student from <%= portal_open_date %>.</p>
                        <% end %>
                      <% end %>
                  <% end %>
                  <br>	
                <% else%>	
                  <% if is_registration_open? %>	
                    <!-- Registration opened -->	
                    <p>	
                      Please fill in the <a href="<%= register_as_student_user_path(@user.id) %>" class="btn btn-primary"> registration form </a>. After you fill out the registration, you will be able to form a team and participate in Orbital application.	
                    </p>	
                  <% else %>	
                    <!-- Registration closed -->	
                    <p>	
                      Registration for Orbital <%=current_cohort%> has closed. Thank you for your interest.	
                    </p>	
                  <% end %>	
                <% end %>	
              </div>	
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
<% end %>